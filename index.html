<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Supply Chain Operations: An Infographic</title>
    <script>
      // Prompt the user for their API key if not already stored locally
      let apiKey = localStorage.getItem('my-gemini-api-key');
      if (!apiKey) {
        apiKey = prompt('Enter your Gemini API key:');
        if (apiKey) {
          localStorage.setItem('my-gemini-api-key', apiKey);
        } else {
          alert('API key is required to use this site.');
          throw new Error('No API key provided');
        }
      }
      // Now you can use apiKey in your API URL as before
      const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            height: 300px;
            max-height: 400px;
        }
        @media (min-width: 768px) {
            .chart-container {
                height: 350px;
            }
        }
        .flow-line {
            width: 2px;
            background-color: #0582CA;
        }
        .flow-line-h {
            height: 2px;
            background-color: #0582CA;
        }
        .flow-arrow::after {
            content: '▼';
            color: #0582CA;
            font-size: 1.5rem;
            line-height: 1;
        }
        .flow-arrow-right::after {
            content: '►';
            color: #0582CA;
            font-size: 1.5rem;
            line-height: 1;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #006494;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
<!-- rest of your body content as before... (unchanged) -->
<!-- ... -->

    <div class="container mx-auto p-4 md:p-8">
        <!-- ... All your sections here ... (unchanged) ... -->
        <!-- Omitted for brevity: all content between <div class="container ..."> and </div> -->
    </div>

    <script>
        function wrapText(text, maxLength) {
            if (typeof text !== 'string' || text.length <= maxLength) {
                return text;
            }
            const words = text.split(' ');
            const lines = [];
            let currentLine = '';
            words.forEach(word => {
                if ((currentLine + ' ' + word).trim().length > maxLength) {
                    lines.push(currentLine.trim());
                    currentLine = word;
                } else {
                    currentLine = (currentLine + ' ' + word).trim();
                }
            });
            if (currentLine) {
                lines.push(currentLine.trim());
            }
            return lines;
        }

        const tooltipTitleCallback = (tooltipItems) => {
            const item = tooltipItems[0];
            let label = item.chart.data.labels[item.dataIndex];
            if (Array.isArray(label)) {
                return label.join(' ');
            }
            return label;
        };
        
        const sharedChartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    position: 'top',
                     labels: {
                        font: {
                            size: 12,
                            family: 'Inter'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        title: tooltipTitleCallback
                    },
                    backgroundColor: '#006494',
                    titleFont: {
                        size: 14,
                        weight: 'bold',
                        family: 'Inter'
                    },
                    bodyFont: {
                        size: 12,
                        family: 'Inter'
                    }
                }
            }
        };

        const ctxInbound = document.getElementById('inboundSourcesChart').getContext('2d');
        new Chart(ctxInbound, {
            type: 'doughnut',
            data: {
                labels: ['Thailand', 'New Zealand'],
                datasets: [{
                    label: 'Finished Goods Volume',
                    data: [703, 27],
                    backgroundColor: ['#00A6FB', '#F9A03F'],
                    borderColor: '#FFFFFF',
                    borderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                ...sharedChartOptions,
                plugins: {
                     ...sharedChartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Finished Goods Inbound Volume by Origin',
                        font: { size: 16, weight: 'bold', family: 'Inter' },
                        color: '#006494',
                        padding: {
                            bottom: 20
                        }
                    }
                },
                cutout: '60%'
            }
        });

        const ctxStakeholders = document.getElementById('stakeholderAllocationChart').getContext('2d');
        new Chart(ctxStakeholders, {
            type: 'pie',
            data: {
                labels: [wrapText('Aladdin (HK) Johny', 16), wrapText('Co-manufacturer Contact', 16), wrapText('WENYIN (IW) Anny/Elvis', 16)],
                datasets: [{
                    label: 'Stakeholder Allocation %',
                    data: [70, 20, 10],
                    backgroundColor: ['#00A6FB', '#0582CA', '#F9A03F'],
                    borderColor: '#FFFFFF',
                    borderWidth: 4,
                    hoverOffset: 8
                }]
            },
            options: {
                 ...sharedChartOptions,
                 plugins: {
                    ...sharedChartOptions.plugins,
                    title: {
                        display: true,
                        text: 'Interpreted Stakeholder Allocation',
                        font: { size: 16, weight: 'bold', family: 'Inter' },
                        color: '#006494',
                        padding: {
                            bottom: 20
                        }
                    }
                 }
            }
        });

        // Gemini API Integration
        async function callGeminiAPI(prompt, outputElement, buttonElement, loaderElement) {
            outputElement.innerHTML = ''; // Clear previous output
            buttonElement.disabled = true;
            loaderElement.style.display = 'block';

            let chatHistory = [];
            chatHistory.push({ role: "user", parts: [{ text: prompt }] });

            const payload = { contents: chatHistory };
            // Use the apiKey from localStorage
            const apiKey = localStorage.getItem('my-gemini-api-key');
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    outputElement.innerHTML = text;
                } else {
                    outputElement.innerHTML = 'Could not get a response. Please try again.';
                    console.error('Unexpected API response structure:', result);
                }
            } catch (error) {
                outputElement.innerHTML = 'Error calling Gemini API. Check console for details.';
                console.error('Error:', error);
            } finally {
                buttonElement.disabled = false;
                loaderElement.style.display = 'none';
            }
        }

        // Quick Explanations
        const termInput = document.getElementById('termInput');
        const explainButton = document.getElementById('explainButton');
        const explainLoader = document.getElementById('explainLoader');
        const explanationOutput = document.getElementById('explanationOutput');

        explainButton.addEventListener('click', () => {
            const term = termInput.value.trim();
            if (term) {
                const prompt = `Provide a concise, 1-2 sentence explanation for the supply chain term: "${term}".`;
                callGeminiAPI(prompt, explanationOutput, explainButton, explainLoader);
            } else {
                explanationOutput.innerHTML = 'Please enter a term to explain.';
            }
        });

        // Supply Chain Insights
        const insightInput = document.getElementById('insightInput');
        const getInsightsButton = document.getElementById('getInsightsButton');
        const insightsLoader = document.getElementById('insightsLoader');
        const insightsOutput = document.getElementById('insightsOutput');

        getInsightsButton.addEventListener('click', () => {
            const userQuery = insightInput.value.trim();
            if (userQuery) {
                const prompt = `Based on the common challenges and processes in global supply chains, and considering details like inbound logistics from Thailand/NZ to Australia, exports from Australia (direct or RPF NZD controlled to RPF SG without hubbing), cross-trade shipments orchestrated by RPF AU, and noted issues like manual documentation (PKL, CIV, VGM, manual invoices, excel tables) and communication patterns ("read payment!"), provide an insight or answer to the following question: "${userQuery}". Focus on practical, actionable insights relevant to optimizing these operations.`;
                callGeminiAPI(prompt, insightsOutput, getInsightsButton, insightsLoader);
            } else {
                insightsOutput.innerHTML = 'Please enter your question or request for insights.';
            }
        });
    </script>

</body>
</html>
